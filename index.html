<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workout Runner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html, body, #root { height: 100%; margin: 0; padding: 0; }
    body { background: #f9fafb; overflow-x: hidden; }
    input, select { font-size: 16px; } /* prevent iOS zoom */
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useEffect, useRef, useState } = React;

    const Button = ({ className = "", children, ...props }) => (
      <button
        className={`px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold w-full ${className}`}
        {...props}
      >{children}</button>
    );
    const GhostButton = ({ className = "", children, ...props }) => (
      <button
        className={`px-4 py-2 rounded-lg border border-gray-300 bg-white w-full ${className}`}
        {...props}
      >{children}</button>
    );

    function useLocalStorage(key, initialValue) {
      const [state, setState] = useState(() => {
        try { const raw = localStorage.getItem(key); return raw != null ? JSON.parse(raw) : initialValue; } catch { return initialValue; }
      });
      useEffect(() => { try { localStorage.setItem(key, JSON.stringify(state)); } catch {} }, [key, state]);
      return [state, setState];
    }

    function useCountdown(ms, running) {
      const [remaining, setRemaining] = useState(ms);
      const rafRef = useRef(null);
      useEffect(() => { setRemaining(ms); }, [ms]);
      useEffect(() => {
        if (!running) { cancelAnimationFrame(rafRef.current); return; }
        const start = performance.now();
        const loop = (t) => {
          const elapsed = t - start;
          const next = Math.max(0, ms - elapsed);
          setRemaining(next);
          if (next > 0) rafRef.current = requestAnimationFrame(loop);
        };
        rafRef.current = requestAnimationFrame(loop);
        return () => cancelAnimationFrame(rafRef.current);
      }, [ms, running]);
      return [remaining, setRemaining];
    }

    function ExerciseRow({ item, index, onDragStart, onDragOver, onDrop, onChange }) {
      return (
        <div
          draggable
          onDragStart={(e)=>onDragStart(e,index)}
          onDragOver={(e)=>onDragOver(e,index)}
          onDrop={(e)=>onDrop(e,index)}
          className="flex flex-col gap-2 p-3 rounded-lg border border-gray-200 bg-white"
        >
          <input className="w-full bg-transparent border-b text-base" value={item.description} onChange={(e)=>onChange(index,{...item, description:e.target.value})} />
          <div className="flex gap-2 w-full">
            <input className="flex-1 bg-gray-50 px-2 py-1 rounded border" type="number" value={Number(item.duration||0)} onChange={(e)=>onChange(index,{...item, duration: Number(e.target.value)})} />
            <select className="flex-1 bg-gray-50 px-2 py-1 rounded border" value={item.unit} onChange={(e)=>onChange(index,{...item, unit: e.target.value})}>
              <option value="seconds">sec</option>
              <option value="reps">reps</option>
            </select>
          </div>
          <input className="w-full bg-transparent border-b text-sm" placeholder="Form cues" value={item.instructions || ""} onChange={(e)=>onChange(index,{...item, instructions:e.target.value})} />
        </div>
      );
    }

    const INITIAL_LIBRARY = [
      {
        title: "Arm & Ab Workout",
        categories: [
          { name: "Arm & Ab Circuit", rounds: 3, exercises: [
            { description: "Plank Hold", duration: 45, unit: "seconds", instructions: "Forearms on ground, elbows under shoulders, keep hips level and glutes engaged." },
            { description: "Bicycle Crunches", duration: 20, unit: "reps", instructions: "Rotate torso, bring elbow to opposite knee, slow and controlled." },
            { description: "Russian Twists", duration: 20, unit: "reps", instructions: "Lean back slightly, twist from core, touch floor each side." },
            { description: "Dumbbell Curl to Press", duration: 12, unit: "reps", instructions: "Curl dumbbells up, then rotate wrists and press overhead. Avoid swinging." },
            { description: "Bench Dips", duration: 12, unit: "reps", instructions: "Hands on bench behind, lower until elbows 90Â°, press up. Keep shoulders down." },
            { description: "Hammer Curls", duration: 12, unit: "reps", instructions: "Neutral grip, curl dumbbells, keep elbows tucked." },
            { description: "Hanging Knee Raises", duration: 12, unit: "reps", instructions: "Hang from bar, lift knees toward chest, avoid swinging." }
          ]}
        ]
      },
      {
        title: "Leg & Glute Workout",
        categories: [
          { name: "Leg & Glute Circuit", rounds: 3, exercises: [
            { description: "Glute Bridge", duration: 15, unit: "reps", instructions: "Heels near glutes, press hips up, squeeze glutes at top." },
            { description: "Side-Lying Clamshells", duration: 15, unit: "reps", instructions: "Band above knees, lift top knee without rolling hips back." },
            { description: "Bulgarian Split Squat", duration: 12, unit: "reps", instructions: "Back foot on bench, lower front thigh parallel, drive through heel." },
            { description: "Step Ups", duration: 12, unit: "reps", instructions: "Step onto bench with whole foot, press through heel, control down." },
            { description: "Romanian Deadlift", duration: 12, unit: "reps", instructions: "Hinge at hips with slight knee bend, back flat, stretch hamstrings, stand tall." },
            { description: "Side Plank Hip Lifts", duration: 12, unit: "reps", instructions: "Elbow under shoulder, lift hips straight up and down, avoid sagging." },
            { description: "Bodyweight Squat Jump", duration: 15, unit: "reps", instructions: "Soft landing, chest tall, use arms for drive. Focus on power for skiing." }
          ]}
        ]
      }
    ];

    function App() {
      const [library, setLibrary] = useLocalStorage("workout_library", INITIAL_LIBRARY);
      const [currentIndex, setCurrentIndex] = useState(0);
      const [mode, setMode] = useState("PLAN");
      const [b, setB] = useState(0);
      const [r, setR] = useState(1);
      const [e, setE] = useState(0);
      const [running, setRunning] = useState(false);
      const [seed, setSeed] = useState(0);
      const [timerDone, setTimerDone] = useState(false);

      const workout = library[currentIndex];
      const blocks = workout.categories;
      const currentBlock = blocks[b];
      const exList = currentBlock?.exercises || [];
      const current = exList[e];

      useEffect(()=>{ setRunning(false); setSeed(s=>s+1); setTimerDone(false); }, [b,r,e,current?.unit,current?.duration]);

      const next = () => {
        if (!currentBlock) return;
        if (e+1 < exList.length) { setE(e+1); return; }
        if (r < currentBlock.rounds) { setE(0); setR(r+1); return; }
        if (b+1 < blocks.length) { setB(b+1); setR(1); setE(0); return; }
        setMode("PLAN");
      };
      const prev = () => { if (e>0) setE(e-1); };

      return (
        <div className="max-w-md mx-auto p-4">
          {mode === "PLAN" && (
            <div className="space-y-4">
              <h1 className="text-xl font-bold mb-2 text-center">{workout.title}</h1>
              <select className="w-full mb-4 p-2 border rounded" value={currentIndex} onChange={(e)=>{ setCurrentIndex(Number(e.target.value)); setB(0); setR(1); setE(0); }}>
                {library.map((w,i)=>(<option key={i} value={i}>{w.title}</option>))}
              </select>
              {blocks.map((blk,bi)=>(
                <div key={bi} className="space-y-2">
                  <div className="flex items-center justify-between">
                    <div className="font-semibold">{blk.name}</div>
                    <input type="number" className="w-20 text-right bg-gray-50 px-2 py-1 rounded border" value={blk.rounds} onChange={(e)=>{
                      const clone = [...library];
                      clone[currentIndex].categories[bi].rounds = Number(e.target.value)||1;
                      setLibrary(clone);
                    }} />
                  </div>
                  {(blk.exercises||[]).map((item,i)=>(
                    <ExerciseRow
                      key={i}
                      item={item}
                      index={i}
                      onDragStart={(ev)=>ev.dataTransfer.setData('text/plain', String(i))}
                      onDragOver={(ev)=>ev.preventDefault()}
                      onDrop={(ev)=>{
                        ev.preventDefault();
                        const from = Number(ev.dataTransfer.getData('text/plain'));
                        const to = i; if (isNaN(from) || from===to) return;
                        const clone = [...library];
                        const arr = [...clone[currentIndex].categories[bi].exercises];
                        const [moved] = arr.splice(from,1);
                        arr.splice(to,0,moved);
                        clone[currentIndex].categories[bi].exercises = arr;
                        setLibrary(clone);
                      }}
                      onChange={(ei, next)=>{
                        const clone = [...library];
                        clone[currentIndex].categories[bi].exercises[ei] = next;
                        setLibrary(clone);
                      }}
                    />
                  ))}
                </div>
              ))}
              <Button onClick={()=>{ setMode("RUN"); setB(0); setR(1); setE(0); }}>Start â¶</Button>
            </div>
          )}

          {mode === "RUN" && current && (
            <div className={`flex flex-col justify-center items-center text-center h-screen gap-6 p-6 rounded-xl border ${timerDone ? 'bg-green-50 border-green-300' : 'bg-white border-gray-200'}`}>
              <div className="text-sm text-gray-500">{currentBlock.name} â¢ Round {r}/{currentBlock.rounds}</div>
              <div className="text-5xl font-extrabold break-words w-full">{current.description}</div>
              {current.instructions && <div className="text-base text-gray-700 max-w-[20rem]">{current.instructions}</div>}
              {current.unit === 'seconds' ? (
                <BigTimer key={seed} ms={current.duration*1000} running={running} onToggle={()=>setRunning(r=>!r)} onComplete={()=>setTimerDone(true)} />
              ) : (
                <div>
                  <div className="text-4xl font-bold">{current.duration} reps</div>
                  <Button onClick={next}>Done â</Button>
                </div>
              )}
              {timerDone && <div className="text-green-600">Timer done â tap Next</div>}
              <div className="flex w-full gap-2">
                <GhostButton onClick={prev}>â Prev</GhostButton>
                <GhostButton onClick={()=>setMode("PLAN")}>Exit</GhostButton>
                <Button onClick={next}>Next â</Button>
              </div>
            </div>
          )}
        </div>
      );
    }

    function BigTimer({ ms, running, onToggle, onComplete }) {
      const [remaining] = useCountdown(ms, running);
      const seconds = Math.ceil(remaining/1000);
      useEffect(()=>{ if (remaining===0) onComplete?.(); }, [remaining,onComplete]);
      return (
        <div className="flex flex-col items-center gap-2">
          <div className={`text-7xl font-bold ${seconds===0?'text-red-600':''}`}>{seconds}</div>
          <GhostButton onClick={onToggle}>{running?"Pause":"Start"}</GhostButton>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>