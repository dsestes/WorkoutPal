<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#111827" />
  <title>Workout Planner + Runner</title>
  <!-- Tailwind (Play CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel for in-browser JSX transform -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html, body, #root { height: 100%; }
    body { background: #f3f4f6; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useEffect, useMemo, useRef, useState } = React;

    // ---------------- UI PRIMITIVES ----------------
    const Card = ({ className = "", children }) => (
      <div className={`rounded-2xl shadow-lg border border-gray-200 bg-white ${className}`}>{children}</div>
    );
    const CardBody = ({ className = "", children }) => (
      <div className={`p-4 sm:p-6 ${className}`}>{children}</div>
    );
    const Button = ({ className = "", children, ...props }) => (
      <button
        className={`px-4 py-2 rounded-xl border bg-gray-900 text-white hover:opacity-90 active:opacity-80 disabled:opacity-40 ${className}`}
        {...props}
      >{children}</button>
    );
    const GhostButton = ({ className = "", children, ...props }) => (
      <button
        className={`px-3 py-2 rounded-xl border border-gray-300 bg-white hover:bg-gray-50 active:bg-gray-100 ${className}`}
        {...props}
      >{children}</button>
    );
    const Toggle = ({ on, onClick }) => (
      <button onClick={onClick} className={`w-12 h-6 rounded-full transition-colors ${on?"bg-green-500":"bg-gray-300"}`}>
        <span className={`block w-5 h-5 bg-white rounded-full transform transition-transform ${on?"translate-x-6":"translate-x-1"}`} />
      </button>
    );
    const Badge = ({ children, tone = "gray" }) => (
      <span className={`inline-flex items-center rounded-full px-2 py-0.5 text-xs border ${
        tone === 'green' ? 'bg-green-50 text-green-700 border-green-200' :
        tone === 'red' ? 'bg-red-50 text-red-700 border-red-200' :
        'bg-gray-50 text-gray-700 border-gray-200'
      }`}>{children}</span>
    );

    // ---------------- HELPERS ----------------
    const toMs = (sec) => Math.max(0, Math.round(Number(sec||0)*1000));
    const LS_KEY_WORKOUT = (title) => `workout_planner_${title||"untitled"}_orderMap_v3`;
    const parseJSON = (raw, fallback) => { try { return JSON.parse(raw); } catch { return fallback; } };
    const deepClone = (x) => JSON.parse(JSON.stringify(x));

    // ---------------- HOOKS ----------------
    function useLocalStorage(key, initialValue) {
      const isBrowser = typeof window !== 'undefined';
      const [state, setState] = useState(() => {
        if (!isBrowser) return initialValue;
        try { const raw = window.localStorage.getItem(key); return raw != null ? JSON.parse(raw) : initialValue; } catch { return initialValue; }
      });
      useEffect(() => { if (!isBrowser) return; try { window.localStorage.setItem(key, JSON.stringify(state)); } catch {} }, [key, state, isBrowser]);
      return [state, setState];
    }
    function useCountdown(ms, running) {
      const [remaining, setRemaining] = useState(ms);
      const rafRef = useRef(null);
      useEffect(() => { setRemaining(ms); }, [ms]);
      useEffect(() => {
        if (!running) { cancelAnimationFrame(rafRef.current); return; }
        const start = performance.now();
        const loop = (t) => {
          const elapsed = t - start;
          const next = Math.max(0, ms - elapsed);
          setRemaining(next);
          if (next > 0) rafRef.current = requestAnimationFrame(loop);
        };
        rafRef.current = requestAnimationFrame(loop);
        return () => cancelAnimationFrame(rafRef.current);
      }, [ms, running]);
      return [remaining, setRemaining];
    }

    // ---------------- DRAG ROW (within a block) ----------------
    function DraggableRow({ item, index, onDragStart, onDragOver, onDrop, onChange }) {
      return (
        <div
          draggable
          onDragStart={(e)=>onDragStart(e,index)}
          onDragOver={(e)=>onDragOver(e,index)}
          onDrop={(e)=>onDrop(e,index)}
          className="flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 cursor-grab"
        >
          <span className="text-gray-400 select-none">≡</span>
          <span className="w-8 text-sm text-gray-500">{index+1}</span>
          <input className="flex-1 min-w-0 bg-transparent outline-none" value={item.description} onChange={(e)=>onChange(index,{...item, description:e.target.value})} />
          <input className="w-20 text-right bg-gray-50 px-2 py-1 rounded-lg border" type="number" value={Number(item.duration||0)} onChange={(e)=>onChange(index,{...item, duration: Number(e.target.value)})} />
          <select className="w-28 bg-gray-50 px-2 py-1 rounded-lg border" value={item.unit} onChange={(e)=>onChange(index,{...item, unit: e.target.value})}>
            <option value="seconds">seconds</option>
            <option value="reps">reps</option>
          </select>
          <input className="flex-1 min-w-0 bg-transparent outline-none" placeholder="Form cues / what to focus on" value={item.instructions || ""} onChange={(e)=>onChange(index,{...item, instructions:e.target.value})} />
        </div>
      );
    }

    // ---------------- INITIAL WORKOUTS ----------------
    const INITIAL_WORKOUT = {
      title: "Full-Body Garage Day — Test Build",
      categories: [
        { name: "Warm-Up", rounds: 1, exercises: [
          { description: "Bike Spin / Easy Row", duration: 180, unit: "seconds", instructions: "Light pace, nasal breathing. RPE 3/10." },
          { description: "PVC Pass-Throughs", duration: 20, unit: "reps", instructions: "Wide grip, ribs down, no elbow bend. Smooth arcs." },
          { description: "World's Greatest Stretch", duration: 60, unit: "seconds", instructions: "Lunge → elbow to instep → T-spine rotation each side." }
        ]},
        { name: "Mobility Prep", rounds: 1, exercises: [
          { description: "Ankles: Knee-to-Wall", duration: 30, unit: "seconds", instructions: "Heel down, knee tracks over toes. Slow pulses." },
          { description: "Scap Prep: Banded Face Pull-Aparts", duration: 20, unit: "reps", instructions: "Pull to nose/forehead. External rotate at end range." },
          { description: "Glute Activation: Mini-Band Walks", duration: 30, unit: "seconds", instructions: "Band above knees. Hips back slightly, steady tension." }
        ]},
        { name: "Block A — Push/Pull/Core", rounds: 3, exercises: [
          { description: "DB Bench Press", duration: 12, unit: "reps", instructions: "Scapulae set, slight arch, touch-and-go with control." },
          { description: "1-Arm DB Row (each)", duration: 10, unit: "reps", instructions: "Hinge, flat back. Row to hip, 1s pause at top." },
          { description: "Tall-Kneeling Pallof Press (each)", duration: 12, unit: "reps", instructions: "Ribs down, squeeze glutes, no trunk rotation." },
          { description: "Push-Up Eccentrics", duration: 30, unit: "seconds", instructions: "3s down, quick up. Stay in the groove, no sag." },
          { description: "Dead Bug", duration: 40, unit: "seconds", instructions: "Low back pressed. Opposite arm/leg extend with slow exhale." }
        ]},
        { name: "Block B — Lower (Hinge/Squat)", rounds: 3, exercises: [
          { description: "Goblet Squat", duration: 12, unit: "reps", instructions: "Full foot, knees track over toes, torso tall." },
          { description: "DB RDL", duration: 10, unit: "reps", instructions: "Hips back, slight knee bend, lats on. Hamstrings loaded." },
          { description: "Reverse Lunge (alt)", duration: 12, unit: "reps", instructions: "Step back, vertical shin on front leg, soft tap knee." },
          { description: "Side Plank (each)", duration: 30, unit: "seconds", instructions: "Elbow under shoulder, hips forward, straight line ear→ankle." }
        ]},
        { name: "Block C — Pull/Shoulders", rounds: 2, exercises: [
          { description: "Pull-Ups or Assisted", duration: 8, unit: "reps", instructions: "Full hang → chin over bar. Drive elbows down. No kip." },
          { description: "DB Incline Fly to Press", duration: 12, unit: "reps", instructions: "2s lower on fly, small stretch, then press. Shoulder-friendly ROM." },
          { description: "Face Pulls (cable/band)", duration: 15, unit: "reps", instructions: "High elbows, ER at end range, squeeze rear delts." }
        ]},
        { name: "Finisher — Conditioning", rounds: 2, exercises: [
          { description: "Bike Erg Hard", duration: 45, unit: "seconds", instructions: "RPE 8/10. Cadence up, keep shoulders relaxed." },
          { description: "Walk-Back Burpees", duration: 12, unit: "reps", instructions: "Step back to plank, snap up. Smooth breathing." },
          { description: "KB Swing", duration: 20, unit: "reps", instructions: "Hinge—not squat. Hike, snap hips, float bell to chest height." }
        ]},
        { name: "Accessory — Arms/Core", rounds: 2, exercises: [
          { description: "DB Hammer Curl", duration: 12, unit: "reps", instructions: "Elbows stay near ribs. No sway." },
          { description: "Cable/Band Triceps Pressdown", duration: 12, unit: "reps", instructions: "Shoulders quiet, full lockout and squeeze." },
          { description: "Hollow Hold or Dead Bug Alt", duration: 30, unit: "seconds", instructions: "Ribs down, scale to tuck as needed." }
        ]},
        { name: "Cooldown", rounds: 1, exercises: [
          { description: "Box Breathing", duration: 120, unit: "seconds", instructions: "In 4 • hold 4 • out 4 • hold 4. Nose breathing." },
          { description: "Calf/Quad Stretch", duration: 60, unit: "seconds", instructions: "Gentle stretch, no pain. Switch sides at halfway." }
        ]}
      ]
    };
    const SAMPLE_LEG_DAY = {
      title: "Leg Day — Strength Bias",
      categories: [
        { name: "Warm-Up", rounds: 1, exercises: [
          { description: "Bike", duration: 120, unit: "seconds" },
          { description: "90/90 Hips", duration: 60, unit: "seconds" }
        ]},
        { name: "Block A — Squat", rounds: 4, exercises: [
          { description: "Back Squat", duration: 5, unit: "reps", instructions: "Bar mid-foot, sit between hips." },
          { description: "Tempo Squat (3-1-1)", duration: 3, unit: "reps", instructions: "Control down, 1s pause, drive." },
        ]},
        { name: "Block B — Hinge/Unilateral", rounds: 3, exercises: [
          { description: "RDL", duration: 8, unit: "reps" },
          { description: "Walking Lunge (alt)", duration: 16, unit: "reps" },
          { description: "Plank", duration: 45, unit: "seconds" },
        ]}
      ]
    };
    const SAMPLE_ARMS_ABS = {
      title: "Arms + Abs — Pump",
      categories: [
        { name: "Block A", rounds: 3, exercises: [
          { description: "DB Hammer Curl", duration: 12, unit: "reps" },
          { description: "Rope Pressdown", duration: 12, unit: "reps" },
          { description: "Hanging Knee Raises", duration: 10, unit: "reps" }
        ]},
        { name: "Block B", rounds: 3, exercises: [
          { description: "Incline DB Curl", duration: 10, unit: "reps" },
          { description: "Overhead Triceps Ext.", duration: 12, unit: "reps" },
          { description: "Pallof Press", duration: 30, unit: "seconds" }
        ]}
      ]
    };

    // ---------------- MAIN APP ----------------
    function App() {
      // Library of routines
      const [library, setLibrary] = useLocalStorage("workout_library_v1", [INITIAL_WORKOUT, SAMPLE_LEG_DAY, SAMPLE_ARMS_ABS]);
      const [currentIndex, setCurrentIndex] = useLocalStorage("workout_current_index", 0);

      // JSON editor state (mirrors selected routine)
      const currentWorkout = library[currentIndex] || INITIAL_WORKOUT;
      const [raw, setRaw] = useLocalStorage("workout_json", JSON.stringify(currentWorkout, null, 2));

      // App prefs
      const [mode, setMode] = useLocalStorage("mode", "PLAN"); // PLAN | RUN
      const [autoAdvance, setAutoAdvance] = useLocalStorage("auto_adv", false);

      // Keep raw in sync when routine changes
      useEffect(()=>{
        setRaw(JSON.stringify(library[currentIndex] || INITIAL_WORKOUT, null, 2));
      }, [currentIndex, library.length]);

      // Parsed workout & blocks
      const workout = useMemo(() => parseJSON(raw, currentWorkout), [raw, currentWorkout]);
      const blocks = workout?.categories || [];

      // Per‑block ordering arrays for the selected workout
      const defaultOrder = useMemo(() => blocks.map(b => b.exercises?.map((_,i)=>i) || []), [workout?.title, blocks.length]);
      const [orderMap, setOrderMap] = useLocalStorage(LS_KEY_WORKOUT(workout?.title), defaultOrder);
      useEffect(()=>{
        // Patch orderMap if structure changed
        if (!Array.isArray(orderMap) || orderMap.length !== blocks.length) {
          setOrderMap(defaultOrder); return;
        }
        let changed = false;
        const patched = orderMap.map((arr, bi) => {
          const want = blocks[bi]?.exercises?.length || 0;
          if (!Array.isArray(arr) || arr.length !== want) { changed = true; return (blocks[bi]?.exercises||[]).map((_,i)=>i); }
          return arr;
        });
        if (changed) setOrderMap(patched);
      }, [blocks.length, blocks.map(b=>b.exercises?.length).join("|")]);

      // RUN state
      const [b, setB] = useLocalStorage("run_b", 0);
      const [r, setR] = useLocalStorage("run_r", 1); // 1-based
      const [e, setE] = useLocalStorage("run_e", 0);
      const [running, setRunning] = useState(false);
      const [seed, setSeed] = useState(0);
      const [timerDone, setTimerDone] = useState(false);

      const currentBlock = blocks[b];
      const blockName = currentBlock?.name || "";
      const blockRounds = Math.max(1, Number(currentBlock?.rounds || 1));
      const blockOrder = orderMap[b] || [];
      const exList = currentBlock?.exercises || [];
      const exIdx = blockOrder[e];
      const current = (exIdx !== undefined) ? exList[exIdx] : null;

      // Totals/progress
      const totalSteps = useMemo(()=> blocks.reduce((sum, blk) => sum + (Math.max(1, Number(blk.rounds||1)) * (blk.exercises?.length||0)), 0), [blocks.map(b=>`${b.rounds}:${b.exercises?.length}`).join("|")]);
      const completedSteps = useMemo(()=>{
        let done = 0;
        for (let bi=0; bi<blocks.length; bi++) {
          const rounds = Math.max(1, Number(blocks[bi].rounds||1));
          const exCount = blocks[bi].exercises?.length || 0;
          if (bi < b) { done += rounds * exCount; continue; }
          if (bi === b) { done += (r-1) * exCount + e; }
        }
        return done;
      }, [blocks, b, r, e]);

      // Reset timer on target change or when switching routines
      useEffect(()=>{ setRunning(false); setSeed(s=>s+1); setTimerDone(false); }, [b, r, e, current?.unit, current?.duration, workout?.title]);

      // Keyboard shortcuts
      useEffect(()=>{
        const onKey = (ev) => {
          if (mode !== 'RUN') return;
          if (ev.code === 'Space') { ev.preventDefault(); if (current?.unit==='seconds') setRunning(x=>!x); }
          if (ev.code === 'Enter' || ev.code === 'ArrowRight') { ev.preventDefault(); next(); }
          if (ev.code === 'ArrowLeft') { ev.preventDefault(); prev(); }
        };
        window.addEventListener('keydown', onKey);
        return () => window.removeEventListener('keydown', onKey);
      }, [mode, current]);

      // Navigation
      const next = () => {
        if (!currentBlock) return;
        const exCount = exList.length;
        if (e + 1 < exCount) { setE(e+1); return; }
        if (r < blockRounds) { setE(0); setR(r+1); return; }
        if (b + 1 < blocks.length) { setB(b+1); setR(1); setE(0); return; }
        setB(blocks.length); // finished
      };
      const prev = () => {
        if (b === 0 && r === 1 && e === 0) return;
        if (e > 0) { setE(e-1); return; }
        if (r > 1) { setR(r-1); setE((exList.length||1)-1); return; }
        if (b > 0) {
          const nb = b - 1;
          const exCount = (blocks[nb].exercises?.length||1);
          const rounds = Math.max(1, Number(blocks[nb].rounds||1));
          setB(nb); setR(rounds); setE(exCount-1);
        }
      };
      const restart = () => { setB(0); setR(1); setE(0); };

      // Import/Export helpers
      const download = () => {
        const blob = new Blob([raw], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `${workout?.title||'workout'}.json`; a.click();
        URL.revokeObjectURL(url);
      };
      const fileRef = useRef(null);
      const upload = (file) => { const reader = new FileReader(); reader.onload = () => setRaw(String(reader.result||"")); reader.readAsText(file); };

      // Library actions
      const saveToCurrent = () => {
        const parsed = parseJSON(raw, null); if (!parsed) return alert('Invalid JSON');
        const nextLib = library.slice();
        nextLib[currentIndex] = parsed;
        setLibrary(nextLib);
      };
      const saveAsNew = () => {
        const parsed = parseJSON(raw, null); if (!parsed) return alert('Invalid JSON');
        const nextLib = library.concat([parsed]);
        setLibrary(nextLib);
        setCurrentIndex(nextLib.length - 1);
      };
      const duplicateCurrent = () => {
        const copy = deepClone(library[currentIndex]);
        copy.title = `${copy.title} (Copy)`;
        const nextLib = library.concat([copy]);
        setLibrary(nextLib);
        setCurrentIndex(nextLib.length - 1);
      };
      const newEmpty = () => {
        const blank = { title: "New Routine", categories: [] };
        const nextLib = library.concat([blank]);
        setLibrary(nextLib); setCurrentIndex(nextLib.length - 1);
      };
      const deleteCurrent = () => {
        if (library.length <= 1) return alert('Keep at least one routine.');
        const idx = currentIndex;
        const nextLib = library.filter((_,i)=>i!==idx);
        setLibrary(nextLib);
        setCurrentIndex(Math.max(0, idx-1));
      };

      return (
        <div className="min-h-screen bg-gray-100 text-gray-900">
          <header className="sticky top-0 z-10 backdrop-blur bg-white/80 border-b">
            <div className="max-w-5xl mx-auto px-4 py-3 flex flex-col gap-3">
              <div className="flex items-center justify-between gap-3">
                <div className="flex items-center gap-3 flex-1">
                  <h1 className="text-xl sm:text-2xl font-bold">{workout?.title || "Workout"}</h1>
                  <div className="text-xs text-gray-500 hidden sm:block">{totalSteps} total steps</div>
                </div>
                <div className="hidden sm:flex items-center gap-2 text-sm">
                  <span className="text-gray-600">Auto-advance</span>
                  <Toggle on={autoAdvance} onClick={()=>setAutoAdvance(!autoAdvance)} />
                </div>
                {mode === 'PLAN' ? (
                  <Button onClick={()=>{ setMode('RUN'); restart(); }}>Start ▶</Button>
                ) : (
                  <div className="flex items-center gap-2">
                    <GhostButton onClick={()=>setMode('PLAN')}>Exit</GhostButton>
                    <GhostButton onClick={restart}>Restart</GhostButton>
                  </div>
                )}
              </div>

              {/* Routine Selector */}
              <div className="flex flex-wrap items-center gap-2">
                <select
                  className="px-3 py-2 rounded-xl border bg-white"
                  value={currentIndex}
                  onChange={(e)=>{ setCurrentIndex(Number(e.target.value)); restart(); }}
                >
                  {library.map((w,i)=>(
                    <option key={i} value={i}>{w.title||`Routine ${i+1}`}</option>
                  ))}
                </select>
                <GhostButton onClick={newEmpty}>New</GhostButton>
                <GhostButton onClick={duplicateCurrent}>Duplicate</GhostButton>
                <GhostButton onClick={deleteCurrent}>Delete</GhostButton>
                <div className="mx-2 h-6 w-px bg-gray-300" />
                <GhostButton onClick={saveToCurrent}>Save to Routine</GhostButton>
                <GhostButton onClick={saveAsNew}>Save As New</GhostButton>
              </div>
            </div>
          </header>

          <main className="max-w-5xl mx-auto px-4 py-6">
            {mode === 'PLAN' && (
              <div className="grid lg:grid-cols-2 gap-6">
                <div className="space-y-6">
                  {blocks.map((blk, bi) => (
                    <Card key={`blk-${bi}`}>
                      <CardBody>
                        <div className="flex items-center justify-between mb-3">
                          <div className="font-semibold text-lg">{blk.name || `Block ${bi+1}`}</div>
                          <div className="flex items-center gap-2 text-sm">
                            <span className="text-gray-600">Rounds</span>
                            <input className="w-16 text-right bg-gray-50 px-2 py-1 rounded-lg border" type="number" value={Number(blk.rounds||1)} onChange={(e)=>{
                              const clone = deepClone(workout);
                              clone.categories[bi].rounds = Math.max(1, Number(e.target.value||1));
                              setRaw(JSON.stringify(clone, null, 2));
                            }} />
                          </div>
                        </div>
                        <div className="space-y-2">
                          {(orderMap[bi]||[]).map((origExIdx, i) => {
                            const item = blk.exercises?.[origExIdx];
                            if (!item) return null;
                            return (
                              <DraggableRow
                                key={`${bi}-${i}-${item.description}`}
                                item={item}
                                index={i}
                                onDragStart={(ev)=>{ ev.dataTransfer.setData('text/plain', String(i)); }}
                                onDragOver={(ev)=>{ ev.preventDefault(); }}
                                onDrop={(ev)=>{
                                  ev.preventDefault();
                                  const from = Number(ev.dataTransfer.getData('text/plain'));
                                  const to = i; if (Number.isNaN(from) || from===to) return;
                                  const map = orderMap.map(arr => [...arr]);
                                  const arr = map[bi];
                                  const [moved] = arr.splice(from,1);
                                  arr.splice(to,0,moved);
                                  setOrderMap(map);
                                }}
                                onChange={(ei, next) => {
                                  const clone = deepClone(workout);
                                  const mappedIdx = orderMap[bi][ei];
                                  const ex = clone.categories[bi].exercises[mappedIdx];
                                  ex.description = next.description;
                                  ex.duration = Number(next.duration||0);
                                  ex.unit = String(next.unit||'seconds');
                                  ex.instructions = next.instructions || "";
                                  setRaw(JSON.stringify(clone, null, 2));
                                }}
                              />
                            );
                          })}
                        </div>
                        <div className="mt-3 text-xs text-gray-500">Drag within the block to set your circuit order. RUN repeats this order each round.</div>
                      </CardBody>
                    </Card>
                  ))}
                </div>

                <Card>
                  <CardBody>
                    <div className="flex items-center justify-between mb-2">
                      <h2 className="text-lg font-semibold">JSON</h2>
                      <div className="flex items-center gap-2">
                        <GhostButton onClick={download}>Download JSON</GhostButton>
                        <input ref={fileRef} type="file" accept="application/json" className="hidden" onChange={(e)=>{ const f=e.target.files?.[0]; if (f) upload(f); }} />
                        <GhostButton onClick={()=>fileRef.current?.click()}>Upload JSON (edit)</GhostButton>
                      </div>
                    </div>
                    <textarea className="w-full h-[640px] font-mono text-sm bg-gray-50 p-3 rounded-xl border" value={raw} onChange={(e)=>setRaw(e.target.value)} />
                    <div className="mt-2 text-xs text-gray-500">Schema: {`{ title, categories:[ { name, rounds, exercises:[ { description, duration, unit:"seconds"|"reps", instructions } ] } ] }`}</div>
                    <TestPanel workout={workout} libraryCount={library.length} />
                  </CardBody>
                </Card>
              </div>
            )}

            {mode === 'RUN' && current && (
              <div className="grid gap-6">
                <Card className={timerDone ? "border-green-300 bg-green-50" : ""}>
                  <CardBody className="flex flex-col gap-6 items-center text-center">
                    <div className="text-sm uppercase tracking-wide text-gray-500">{blockName || `Block ${b+1}`} • Round {r}/{blockRounds} • Step {completedSteps+1}/{totalSteps}</div>
                    <div className="text-4xl sm:text-5xl font-extrabold leading-tight text-center">{current.description}</div>
                    <div className="max-w-2xl text-lg text-gray-700 whitespace-pre-wrap">{current.instructions || "Focus on smooth, controlled reps. Breathe."}</div>

                    {current.unit === 'seconds' ? (
                      <BigTimer
                        key={`timer-${seed}`}
                        ms={toMs(current.duration)}
                        running={running}
                        onToggle={()=>setRunning(rn=>!rn)}
                        onComplete={()=>{ setTimerDone(true); if (autoAdvance) next(); }}
                      />
                    ) : (
                      <RepBlock reps={Number(current.duration||10)} onDone={()=> next()} />
                    )}

                    {timerDone && (
                      <div className="text-sm text-green-700">Timer done — tap Next to continue</div>
                    )}

                    <div className="flex flex-wrap gap-2 justify-center">
                      <GhostButton onClick={prev}>◀ Prev</GhostButton>
                      {current.unit === 'seconds' && (
                        <GhostButton onClick={()=>setRunning(rn=>!rn)}>{running?"Pause":"Start"}</GhostButton>
                      )}
                      <Button onClick={next}>Next ✓</Button>
                    </div>
                  </CardBody>
                </Card>

                <Card>
                  <CardBody className="flex flex-wrap items-center justify-between gap-3 text-sm text-gray-600">
                    <div className="flex items-center gap-3">
                      <span className="bg-gray-200 rounded-full px-2 py-1">Space</span>
                      <span>start/pause timer</span>
                    </div>
                    <div className="flex items-center gap-3">
                      <span className="bg-gray-200 rounded-full px-2 py-1">Enter / →</span>
                      <span>next exercise</span>
                    </div>
                    <div className="flex items-center gap-3">
                      <span className="bg-gray-200 rounded-full px-2 py-1">←</span>
                      <span>previous</span>
                    </div>
                    <div className="flex items-center gap-3">
                      <span className="bg-gray-200 rounded-full px-2 py-1">Auto-advance</span>
                      <span>if ON, moves on when timer hits 0</span>
                    </div>
                  </CardBody>
                </Card>
              </div>
            )}

            {mode === 'RUN' && !current && (
              <Card>
                <CardBody className="text-center">
                  <div className="text-3xl font-bold mb-2">All blocks complete ✅</div>
                  <div className="text-gray-600">Solid work. Want another go or tweak the order?</div>
                  <div className="mt-4 flex gap-2 justify-center">
                    <Button onClick={restart}>Restart</Button>
                    <GhostButton onClick={()=>setMode('PLAN')}>Back to Plan</GhostButton>
                  </div>
                </CardBody>
              </Card>
            )}
          </main>

          <footer className="py-8 text-center text-xs text-gray-400">Built for Dan’s garage gym ✌️</footer>
        </div>
      );
    }

    function BigTimer({ ms, running, onToggle, onComplete }) {
      const [remaining] = useCountdown(ms, running);
      const seconds = Math.ceil(remaining/1000);
      useEffect(()=>{ if (remaining === 0) onComplete?.(); }, [remaining, onComplete]);
      return (
        <div className="flex flex-col items-center gap-2">
          <div className={`text-6xl sm:text-7xl font-bold tabular-nums ${seconds===0? 'text-red-600':''}`}>{seconds}</div>
          <div className="flex gap-2">
            <GhostButton onClick={onToggle}>{running?"Pause":"Start"}</GhostButton>
          </div>
        </div>
      );
    }
    function RepBlock({ reps, onDone }) {
      return (
        <div className="flex flex-col items-center gap-2">
          <div className="text-6xl sm:text-7xl font-bold tabular-nums">{reps}</div>
          <div className="text-gray-500">Complete the reps, then tap Done</div>
          <GhostButton onClick={onDone}>Done ✓</GhostButton>
        </div>
      );
    }

    function TestPanel({ workout, libraryCount }) {
      const results = useMemo(() => {
        const out = [];
        try {
          const k = `__test_${Math.random().toString(36).slice(2)}`;
          window.localStorage.setItem(k, JSON.stringify("ok"));
          const v = JSON.parse(window.localStorage.getItem(k));
          out.push({ name: 'localStorage roundtrip', pass: v === 'ok' });
          window.localStorage.removeItem(k);
        } catch { out.push({ name: 'localStorage roundtrip', pass: false }); }
        try {
          const expected = 53;
          const got = (workout?.categories||[]).reduce((sum, blk) => sum + (Math.max(1, Number(blk.rounds||1)) * (blk.exercises?.length||0)), 0);
          out.push({ name: 'totalSteps matches expected (53)', pass: got === expected, info: `got ${got}` });
        } catch { out.push({ name: 'totalSteps matches expected (53)', pass: false }); }
        try { out.push({ name: 'library present', pass: libraryCount >= 1, info: `count=${libraryCount}` }); } catch { out.push({ name: 'library present', pass: false }); }
        try {
          const exCount = 5; const rounds = 3; let e=0, r=1, steps=0; const N=exCount*rounds; while (steps<N-1){ if (e+1<exCount) e++; else if (r<rounds){ r++; e=0; } steps++; }
          out.push({ name: 'next() sim 3x5 ends last ex', pass: (r===3 && e===4) });
        } catch { out.push({ name: 'next() sim 3x5 ends last ex', pass: false }); }
        return out;
      }, [workout, libraryCount]);

      return (
        <div className="mt-4 p-3 rounded-xl border bg-white">
          <div className="font-semibold mb-2 text-sm">Test Panel</div>
          <ul className="space-y-1">
            {results.map((t, i) => (
              <li key={i} className="flex items-center gap-2 text-sm">
                <Badge tone={t.pass? 'green' : 'red'}>{t.pass? 'PASS' : 'FAIL'}</Badge>
                <span>{t.name}</span>
                {t.info && <span className="text-xs text-gray-500">({t.info})</span>}
              </li>
            ))}
          </ul>
          <div className="mt-2 text-xs text-gray-500">Tests are lightweight sanity checks. If any fail after heavy schema edits, ping me and we’ll update them.</div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
