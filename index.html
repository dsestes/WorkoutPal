<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#111827" />
  <title>Workout Runner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html, body, #root { height: 100%; }
    body { background: #f3f4f6; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useEffect, useMemo, useRef, useState } = React;

    const Button = ({ className = "", children, ...props }) => (
      <button
        className={`px-4 py-2 rounded-xl border bg-gray-900 text-white hover:opacity-90 active:opacity-80 disabled:opacity-40 ${className}`}
        {...props}
      >{children}</button>
    );
    const GhostButton = ({ className = "", children, ...props }) => (
      <button
        className={`px-3 py-2 rounded-xl border border-gray-300 bg-white hover:bg-gray-50 active:bg-gray-100 ${className}`}
        {...props}
      >{children}</button>
    );

    function useLocalStorage(key, initialValue) {
      const [state, setState] = useState(() => {
        try { const raw = localStorage.getItem(key); return raw != null ? JSON.parse(raw) : initialValue; } catch { return initialValue; }
      });
      useEffect(() => { try { localStorage.setItem(key, JSON.stringify(state)); } catch {} }, [key, state]);
      return [state, setState];
    }
    function useCountdown(ms, running) {
      const [remaining, setRemaining] = useState(ms);
      const rafRef = useRef(null);
      useEffect(() => { setRemaining(ms); }, [ms]);
      useEffect(() => {
        if (!running) { cancelAnimationFrame(rafRef.current); return; }
        const start = performance.now();
        const loop = (t) => {
          const elapsed = t - start;
          const next = Math.max(0, ms - elapsed);
          setRemaining(next);
          if (next > 0) rafRef.current = requestAnimationFrame(loop);
        };
        rafRef.current = requestAnimationFrame(loop);
        return () => cancelAnimationFrame(rafRef.current);
      }, [ms, running]);
      return [remaining, setRemaining];
    }

    function DraggableRow({ item, index, onDragStart, onDragOver, onDrop, onChange }) {
      return (
        <div
          draggable
          onDragStart={(e)=>onDragStart(e,index)}
          onDragOver={(e)=>onDragOver(e,index)}
          onDrop={(e)=>onDrop(e,index)}
          className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 p-3 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 cursor-grab"
        >
          <span className="text-gray-400 select-none">≡</span>
          <input className="flex-1 min-w-0 bg-transparent outline-none text-sm" value={item.description} onChange={(e)=>onChange(index,{...item, description:e.target.value})} />
          <div className="flex gap-2 items-center">
            <input className="w-16 text-right bg-gray-50 px-2 py-1 rounded-lg border text-sm" type="number" value={Number(item.duration||0)} onChange={(e)=>onChange(index,{...item, duration: Number(e.target.value)})} />
            <select className="w-24 bg-gray-50 px-2 py-1 rounded-lg border text-sm" value={item.unit} onChange={(e)=>onChange(index,{...item, unit: e.target.value})}>
              <option value="seconds">sec</option>
              <option value="reps">reps</option>
            </select>
          </div>
          <input className="flex-1 min-w-0 bg-transparent outline-none text-sm" placeholder="Form cues" value={item.instructions || ""} onChange={(e)=>onChange(index,{...item, instructions:e.target.value})} />
        </div>
      );
    }

    const INITIAL_WORKOUT = {
      title: "Sample Workout",
      categories: [
        { name: "Block A", rounds: 2, exercises: [
          { description: "Push Ups", duration: 10, unit: "reps", instructions: "Chest to floor." },
          { description: "Plank", duration: 30, unit: "seconds", instructions: "Keep hips level." }
        ]}
      ]
    };

    function App() {
      const [workout, setWorkout] = useLocalStorage("workout_simple", INITIAL_WORKOUT);
      const [mode, setMode] = useState("PLAN");
      const [b, setB] = useState(0);
      const [r, setR] = useState(1);
      const [e, setE] = useState(0);
      const [running, setRunning] = useState(false);
      const [seed, setSeed] = useState(0);
      const [timerDone, setTimerDone] = useState(false);

      const blocks = workout.categories;
      const currentBlock = blocks[b];
      const exList = currentBlock?.exercises || [];
      const current = exList[e];

      useEffect(()=>{ setRunning(false); setSeed(s=>s+1); setTimerDone(false); }, [b,r,e,current?.unit,current?.duration]);

      const next = () => {
        if (!currentBlock) return;
        if (e+1 < exList.length) { setE(e+1); return; }
        if (r < currentBlock.rounds) { setE(0); setR(r+1); return; }
        if (b+1 < blocks.length) { setB(b+1); setR(1); setE(0); return; }
        setMode("PLAN");
      };
      const prev = () => { if (e>0) setE(e-1); };

      return (
        <div className="max-w-md mx-auto p-4">
          {mode === "PLAN" && (
            <div className="space-y-4">
              <h1 className="text-xl font-bold mb-2">{workout.title}</h1>
              {blocks.map((blk,bi)=>(
                <div key={bi} className="space-y-2">
                  <div className="flex items-center justify-between">
                    <div className="font-semibold">{blk.name}</div>
                    <input type="number" className="w-16 text-right bg-gray-50 px-2 py-1 rounded-lg border text-sm" value={blk.rounds} onChange={(e)=>{
                      const clone = {...workout};
                      clone.categories[bi].rounds = Number(e.target.value)||1;
                      setWorkout(clone);
                    }} />
                  </div>
                  {(blk.exercises||[]).map((item,i)=>(
                    <DraggableRow
                      key={i}
                      item={item}
                      index={i}
                      onDragStart={(ev)=>ev.dataTransfer.setData('text/plain', String(i))}
                      onDragOver={(ev)=>ev.preventDefault()}
                      onDrop={(ev)=>{
                        ev.preventDefault();
                        const from = Number(ev.dataTransfer.getData('text/plain'));
                        const to = i; if (isNaN(from) || from===to) return;
                        const clone = {...workout};
                        const arr = [...clone.categories[bi].exercises];
                        const [moved] = arr.splice(from,1);
                        arr.splice(to,0,moved);
                        clone.categories[bi].exercises = arr;
                        setWorkout(clone);
                      }}
                      onChange={(ei, next)=>{
                        const clone = {...workout};
                        clone.categories[bi].exercises[ei] = next;
                        setWorkout(clone);
                      }}
                    />
                  ))}
                </div>
              ))}
              <Button onClick={()=>{ setMode("RUN"); setB(0); setR(1); setE(0); }}>Start ▶</Button>
            </div>
          )}

          {mode === "RUN" && current && (
            <div className="flex flex-col gap-4 items-center text-center">
              <div className="text-sm text-gray-500">{currentBlock.name} • Round {r}/{currentBlock.rounds}</div>
              <div className="text-3xl font-bold">{current.description}</div>
              <div className="text-gray-700">{current.instructions}</div>
              {current.unit === 'seconds' ? (
                <BigTimer key={seed} ms={current.duration*1000} running={running} onToggle={()=>setRunning(r=>!r)} onComplete={()=>setTimerDone(true)} />
              ) : (
                <div>
                  <div className="text-4xl font-bold">{current.duration} reps</div>
                  <Button onClick={next}>Done ✓</Button>
                </div>
              )}
              {timerDone && <div className="text-green-600">Timer done — tap Next</div>}
              <div className="flex gap-2">
                <GhostButton onClick={prev}>◀ Prev</GhostButton>
                {current.unit === 'seconds' && <GhostButton onClick={()=>setRunning(r=>!r)}>{running?"Pause":"Start"}</GhostButton>}
                <Button onClick={next}>Next ✓</Button>
              </div>
            </div>
          )}
        </div>
      );
    }

    function BigTimer({ ms, running, onToggle, onComplete }) {
      const [remaining] = useCountdown(ms, running);
      const seconds = Math.ceil(remaining/1000);
      useEffect(()=>{ if (remaining===0) onComplete?.(); }, [remaining,onComplete]);
      return (
        <div className="flex flex-col items-center gap-2">
          <div className={`text-6xl font-bold ${seconds===0?'text-red-600':''}`}>{seconds}</div>
          <GhostButton onClick={onToggle}>{running?"Pause":"Start"}</GhostButton>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
